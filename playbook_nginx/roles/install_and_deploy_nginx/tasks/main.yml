---
# tasks file for install_nginx
- name: Allow nginx to connect to custom ports
  seboolean:
    name: nis_enabled
    state: true
    persistent: yes

- name: Set SELinux port context for custom ports
  selinux_port:
    ports: 9080,9443
    proto: tcp
    setype: http_port_t
    state: present

- name: enable 9080
  firewalld:
    port: 9080/tcp
    permanent: true
    state: enabled

- name: enable 9443
  firewalld:
    port: 9443/tcp
    permanent: true
    state: enabled

- name: Reload firewalld
  firewalld:
    state: reloaded

- name: Install nginx for server
  package:
    name: nginx
    state: latest
    update_cache: yes

- name: Start nginx for servers
  service:
    name: nginx
    state: started

- name: Copy main config file for nginx - nginx.conf
  template:
    src: ../templates/nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    mode: 0744
  notify: restart nginx
    
- name: Copy config file for nginx - http.conf
  template:
    src: ../templates/http.conf.j2
    dest: /etc/nginx/conf.d/http.conf
    mode: 0744
  notify: restart nginx

- name: Create ssl dir
  file:
    path: /etc/nginx/ssl
    state: directory

- name: Copy cert and key on hosts
  copy:
    src: "../files/{{ item }}"
    dest: "{{ ssl_dir }}"
  with_items:
    - example.crt
    - example.key
